# Django Web Application Pod for Bake with Love Bakery
apiVersion: v1
kind: Pod
metadata:
  name: bakery-web
  namespace: bakery
  labels:
    app: bake-with-love
    component: web
spec:
  initContainers:
    # Wait for database to be ready
    - name: wait-for-db
      image: busybox:1.36
      command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until nc -z bakery-db 5432; do
            echo "PostgreSQL is not ready yet...sleeping"
            sleep 2
          done
          echo "PostgreSQL is ready!"
  containers:
    - name: django
      image: naman7564/bake-with-love:latest
      imagePullPolicy: Never
      ports:
        - containerPort: 8000
          name: http
      env:
        - name: DEBUG
          value: "True"
        - name: SECRET_KEY
          value: "django-insecure-bakery-dev-key-change-in-production"
        - name: DB_NAME
          value: "bakery_db"
        - name: DB_USER
          value: "bakery_user"
        - name: DB_PASSWORD
          value: "bakery_password"
        - name: DB_HOST
          value: "bakery-db"
        - name: DB_PORT
          value: "5432"
        - name: ALLOWED_HOSTS
          value: "localhost,127.0.0.1,0.0.0.0,*"
        - name: CSRF_TRUSTED_ORIGINS
          value: "http://localhost:8000,http://127.0.0.1:8000"
      command:
        - sh
        - -c
        - |
          python manage.py makemigrations core --noinput &&
          python manage.py migrate &&
          python manage.py collectstatic --noinput &&
          gunicorn --bind 0.0.0.0:8000 --workers 3 bakery_project.wsgi:application
      readinessProbe:
        httpGet:
          path: /
          port: 8000
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
      livenessProbe:
        httpGet:
          path: /
          port: 8000
        initialDelaySeconds: 60
        periodSeconds: 30
        timeoutSeconds: 5
      resources:
        requests:
          memory: "256Mi"
          cpu: "250m"
        limits:
          memory: "512Mi"
          cpu: "500m"
---
# Web Service
apiVersion: v1
kind: Service
metadata:
  name: bakery-web
  namespace: bakery
  labels:
    app: bake-with-love
    component: web
spec:
  selector:
    app: bake-with-love
    component: web
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 30080
      name: http
  type: NodePort

{% extends 'admin_panel/base.html' %}

{% block title %}Blocked Users{% endblock %}

{% block content %}
<div class="admin-page-header">
    <div>
        <h1>ğŸš« Blocked Users</h1>
        <p class="admin-page-subtitle">Manage blocked users, phones, and IPs</p>
    </div>
    <a href="{% url 'admin_panel:blocked_user_create' %}" class="btn-admin-primary">+ Add Block</a>
</div>

<!-- Stats -->
<div class="stats-grid" style="margin-bottom: 24px;">
    <div class="stat-card stat-pending">
        <div class="stat-icon">ğŸš«</div>
        <div class="stat-info">
            <span class="stat-value">{{ total_blocked }}</span>
            <span class="stat-label">Active Blocks</span>
        </div>
    </div>
    <div class="stat-card stat-orders">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-info">
            <span class="stat-value">{{ today_orders_tracked }}</span>
            <span class="stat-label">Today's Rate Limits</span>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-row">
    <a href="{% url 'admin_panel:blocked_users' %}" 
       class="filter-btn {% if not current_status and not current_reason %}active{% endif %}">All</a>
    <a href="{% url 'admin_panel:blocked_users' %}?status=active" 
       class="filter-btn {% if current_status == 'active' %}active{% endif %}">Active</a>
    <a href="{% url 'admin_panel:blocked_users' %}?status=inactive" 
       class="filter-btn {% if current_status == 'inactive' %}active{% endif %}">Inactive</a>
    <a href="{% url 'admin_panel:blocked_users' %}?reason=cancelled" 
       class="filter-btn {% if current_reason == 'cancelled' %}active{% endif %}">Too Many Cancellations</a>
    <a href="{% url 'admin_panel:blocked_users' %}?reason=spam" 
       class="filter-btn {% if current_reason == 'spam' %}active{% endif %}">Spam</a>
    <a href="{% url 'admin_panel:blocked_users' %}?reason=manual" 
       class="filter-btn {% if current_reason == 'manual' %}active{% endif %}">Manual</a>
</div>

<div class="admin-card">
    <div class="card-header">
        <h3>Block List</h3>
        <form method="GET" class="search-form">
            <input type="text" name="q" value="{{ search_query }}" placeholder="Search phone, IP, or email..."
                class="admin-input" style="width: 250px;">
        </form>
    </div>
    <div class="card-body">
        <div class="admin-table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Target</th>
                        <th>Phone</th>
                        <th>IP Address</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Blocked At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for block in blocked_users %}
                    <tr>
                        <td>
                            {% if block.user %}
                            <div class="user-cell">
                                <span class="user-avatar-sm">{{ block.user.first_name|slice:":1"|upper }}{{ block.user.last_name|slice:":1"|upper }}</span>
                                <div>
                                    <strong>{{ block.user.full_name|default:block.user.username }}</strong>
                                    <br><small class="text-muted">{{ block.user.email }}</small>
                                </div>
                            </div>
                            {% else %}
                            <span class="text-muted">â€”</span>
                            {% endif %}
                        </td>
                        <td>{{ block.phone|default:"â€”" }}</td>
                        <td>{{ block.ip_address|default:"â€”" }}</td>
                        <td>
                            {% if block.reason == 'cancelled' %}
                            <span class="status-badge status-cancelled">Cancelled Orders</span>
                            {% elif block.reason == 'spam' %}
                            <span class="status-badge status-pending">Spam</span>
                            {% else %}
                            <span class="status-badge status-confirmed">Manual</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if block.is_active %}
                            <span class="badge badge-danger">Blocked</span>
                            {% else %}
                            <span class="badge badge-muted">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ block.blocked_at|date:"M d, Y H:i" }}</td>
                        <td>
                            <div class="table-actions">
                                <a href="{% url 'admin_panel:blocked_user_edit' block_id=block.id %}" 
                                   class="action-btn" title="Edit">âœï¸</a>
                                <a href="{% url 'admin_panel:blocked_user_toggle' block_id=block.id %}" 
                                   class="action-btn" title="Toggle Status">
                                    {% if block.is_active %}ğŸ”“{% else %}ğŸ”’{% endif %}
                                </a>
                                <form action="{% url 'admin_panel:blocked_user_delete' block_id=block.id %}" 
                                      method="POST" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-btn" title="Delete" 
                                            onclick="return confirm('Are you sure you want to delete this block?')">ğŸ—‘ï¸</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No blocked users found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
